Bootstrap: library
From: ubuntu:18.04

####
#
# Author: 		Chris Wood, EPCC, University of Edinburgh <c.wood@epcc.ed.ac.uk>
# Date: 		2019-09-06
# Last updated: 2019-10-31
#
#	Unresolved issues / future work:
#		- do we _need_ to (should we) run all available `make [check|test]` for dependencies?
#		- did I waste a lot of time working out how to compile dependencies from source? (David H suggested that some apt binaries might work, despite my comment below!)
#		- we could change the workflow of all of this by creating individual docker files of all the dependencies (with same base OS image, probably something minimal? alpine?),
#		  doing a multistage build, and creating the singularity container from the final resultant docker container. Singularity doensn't (yet) allow multistage builds
#		- one of the issues I had running `make check` for hdf5 was with running it as root - mpiexec complains about this. I created the nemo user to run (with the side effect that
#		  it created a useful location - the home directory - to store some of the dependencies!). But I then had issues with adding the hdf5 libraries to search paths used by NetCDF, nemo, and xios,
#		  so changed --prefix from /home/nemo/hdf5 to /usr/local, but you can't install stuff to there without being root (or sudo, which isn't directly supported in a container). Way round it would be
#		  build in /home/nemo as nemo, then install as root, and switch back to nemo user? Is it worth it? But only need to worry about this if we want to run `make check`. Also had similar issues with
#		  NCDIR and NFDIR for NetCDF install directories (changed from /home/nemo/netcdf/install to /usr/local). If there's a way round it (and there's a reason to do it), then LD_LIBRARY_PATH and PATH
#		  will need to be set and updated
#
#		  I also thought it would be useful to keep all the 3rd party dependencies in a separate place, rather than /usr/local, but maybe that's just being a bit OCD...
#		- the nemo-singularity repo is currently private, so need to supply a username/password
#		- I keep the def file in a different repo to the singularity nemo build because	it is a different thing - someone running `singularity build` doesn't need the whole singularity-nemo repo (apart from
#		  inside the container)	
#
#		- note I currently change branch in the nemo singularity repo rather than use master
####

%post

	##
	# Compilation from source necessary where apt-get binaries weren't compiled with necessary dependencies
	# for XIOS and NEMO
	##

	# install basic stuff
	apt-get install -y software-properties-common
	add-apt-repository universe
	apt-get update
	apt-get install -y subversion \
					   wget \
					   git \
					   make \
					   m4 \
					   gcc \
					   gfortran \
					   g++ \
					   locales \
					   locales-all \
					   liburi-perl \
					   python
			
	locale-gen en_US en_US.UTF-8
	ln -s /usr/bin/make /usr/bin/gmake

	# compiling curl from source https://curl.haxx.se/docs/install.html
	mkdir -p /opt/curl && cd $_
	wget https://curl.haxx.se/download/curl-7.66.0.tar.gz
	tar xvzf curl-7.66.0.tar.gz
	rm curl-7.66.0.tar.gz
	cd curl-7.66.0
	./configure
	make
	make test
	make install

	# compiling openmpi from source
	mkdir -p /opt/openmpi-4.0.1 && cd $_
	wget https://download.open-mpi.org/release/open-mpi/v4.0/openmpi-4.0.1.tar.gz
	tar -xvzf openmpi-4.0.1.tar.gz
	rm openmpi-4.0.1.tar.gz
	cd openmpi-4.0.1
	./configure CC=gcc CXX=g++ FC=gfortran --enable-mpi1-compatibility --prefix=/opt/openmpi-4.0.1/install
	make
	make install

	# add user `nemo` - mpiexec in hdf5 `make check` complains if run as root (although we might end up not running make check)
	adduser --disabled-password --gecos "" nemo

	WORK_DIR=/nemo
	mkdir $WORK_DIR
	chown nemo:nemo -R $WORK_DIR
	cd $WORK_DIR

	# compile zlib from source
	mkdir /home/nemo/zlib && cd $_
	ZDIR=/usr/local #/home/nemo/zlib/install
	wget http://www.zlib.net/zlib-1.2.11.tar.xz
	tar --xz -x -v -f zlib-1.2.11.tar.xz 
	rm zlib-1.2.11.tar.xz
	cd zlib-1.2.11
	./configure --prefix=${ZDIR}
	make
	make check
	make install

	# compile HDF5 libraries
	mkdir /home/nemo/hdf5 && cd $_
	wget -O hdf5.tar.gz "https://www.hdfgroup.org/package/hdf5-1-10-5-tar-gz/?wpdmdl=13571&refresh=5d94c86107ca21570031713"
	tar xzvf hdf5.tar.gz
	rm hdf5.tar.gz
	H5DIR=/usr/local # /home/nemo/hdf5/install
	cd hdf5-1.10.5 
	# n.b. --enable-fortran specifically not needed (https://www.unidata.ucar.edu/software/netcdf/docs/getting_and_building_netcdf.html#build_default)
	CC=/opt/openmpi-4.0.1/install/bin/mpicc ./configure --with-zlib=${ZDIR} --prefix=${H5DIR} --enable-hl --enable-parallel 
	make
	# maybe we shouldn't bother with make check - it complains about a lot and we're not actually building on a parallel file system
	# so some of the checks are totally irrelevant
	# make check -i RUNPARALLEL='-oversubscribe'
	make install

	# and add this symlink (for xios / nemo) - can't do ln as nemo user
	ln -s /opt/openmpi-4.0.1/install/bin/mpif90 /usr/bin/mpif90

	##
	# hmm, maybe netCDF doesn't like anything being anywhere but /usr/local...
	# but: I wanted to install hdf5 library locally because make check runs mpiexec, which complains if it's run as root
	# ... but non-root can't install to /usr/local?
	##

	##
	# I originally had NCDIR and NFDIR as /home/nemo/netcdf/install but even adding this to PATH and LD_LIBRARY_LINK
	##

	# compile NetCDF libs
	mkdir -p /home/nemo/netcdf && cd $_
	#cd $WORK_DIR
	wget -O netcdf.tar.gz https://github.com/Unidata/netcdf-c/archive/v4.7.1.tar.gz
	tar xzvf netcdf.tar.gz
	rm netcdf.tar.gz 
	cd netcdf-c-4.7.1
	NCDIR=/usr/local
	#NCDIR=/home/nemo/netcdf/install
	

	#CC=/opt/openmpi-4.0.1/bin/mpicc FC=/opt/openmpi-4.0.1/bin/mpifort CPPFLAGS=-I${H5DIR}/include LDFLAGS=-L${H5DIR}/lib ./configure --disable-shared --enable-parallel-tests --prefix=${NCDIR}

	#CC=/opt/openmpi-4.0.1/bin/mpicc FC=/opt/openmpi-4.0.1/bin/mpifort CPPFLAGS=-I${H5DIR}/include LDFLAGS="-L${H5DIR}/lib -L${ZDIR}/lib" ./configure --disable-shared --enable-parallel-tests --prefix=${NCDIR}
	

	CC=/opt/openmpi-4.0.1/install/bin/mpicc FC=/opt/openmpi-4.0.1/install/bin/mpifort CPPFLAGS=-I${H5DIR}/include LDFLAGS=-L${H5DIR}/lib ./configure --disable-shared --prefix=$NCDIR


	
	make
	# make check fails; again - maybe we should avoid running it (only 1 response from a question on the netcdf mailing list, saying it is really finicky) 
	# make check
	make install

	## and the fortran libraries
	cd ..
	wget https://github.com/Unidata/netcdf-fortran/archive/v4.5.2.tar.gz
	tar xzvf v4.5.2.tar.gz
	rm v4.5.2.tar.gz
	cd netcdf-fortran-4.5.2/
	NFDIR=/usr/local
	#NFDIR=/home/nemo/netcdf/install

	#CPPFLAGS=-I${NCDIR}/include LDFLAGS=-L${NCDIR}/lib ./configure --prefix=${NFDIR}

	#CC=/opt/openmpi-4.0.1/install/bin/mpicc FC=/opt/openmpi-4.0.1/install/bin/mpifort CPPFLAGS="-I${NCDIR}/include -I${H5DIR}/include" LDFLAGS="-L${NCDIR}/lib -L${H5DIR}/lib" ./configure --prefix=$NCDIR --disable-fortran-type-check




	CC=/opt/openmpi-4.0.1/install/bin/mpicc FC=/opt/openmpi-4.0.1/install/bin/mpifort CPPFLAGS=-I${NCDIR}/include LDFLAGS="-L${NCDIR}/lib" LIBS="-lhdf5 -lhdf5_hl -lcurl" ./configure --prefix=$NFDIR --disable-shared
	make
	make install

	su nemo
	WORK_DIR=/nemo
	PATH=$PATH:/opt/openmpi-4.0.1/install/bin


#	PATH=$PATH:/home/nemo/netcdf/install/bin
#	PATH=$PATH:/home/nemo/netcdf/install/lib 
#	PATH=$PATH:/home/nemo/netcdf/install/include 
#	PATH=$PATH:/home/nemo/netcdf/install/share

#	LD_LIBRARY_PATH=/home/nemo/netcdf/install/include:$LD_LIBRARY_PATH

	# get singularity nemo
	cd $WORK_DIR
	# this asks for username & password...
	git clone https://github.com/NOC-MSM/singularity-nemo
	cd singularity-nemo

	# dev branch
	git checkout def-file-development

	cd scripts
	./nemo_setup -x /nemo -w /nemo -s /nemo/singularity-nemo

	# clean up
	cd $WORK_DIR
	rm -vf *.tar.*


#hmm, arch=GCC_LINUX

#./make_xios --full --prod --arch GCC_LINUX --netcdf_lib netcdf4_par --job 1


 - edit arch-linux_gfortran:

%NCDF_HOME           /usr
%HDF5_HOME           /usr/local
%XIOS_HOME           /nemo/xios

./makenemo -m linux_gfortran -r ORCA2_ICE_PISCES -j 1

#sudo ln -s /usr/bin/make /usr/bin/gmake
#sudo ln -s /usr/bin/mpicc /usr/bin/mpiicc
#sudo ln -s /usr/share/openmpi/mpicc-wrapper-data.txt /usr/share/openmpi/mpiicc-wrapper-data.txt 

#create copies of arch-cirrus* to arch-singularity
#replace nofor-main with Wno-main
#arch=singularity




apt-get install build-essential


	# install gfortran
	#apt-get install -y gfortran g++

	# install gcc
#	apt-get install -y gcc

	# install hdf5
#	apt-get install -y libhdf5-dev


#	apk update
#	apk add subversion wget git
#
#	apk add gcc
#
#	apk add --no-cache \
#            --allow-untrusted \
#            --repository \
#             http://dl-3.alpinelinux.org/alpine/edge/testing \
#            hdf5 \
#            hdf5-dev

    git clone https://github.com/NOC-MSM/singularity-nemo
	cd singularity-nemo/scripts
	# ./nemo_setup -w /home/vagrant/ -x /home/vagrant -s /home/vagrant/singularity-nemo/
	#./nemo_setup -w /nemo -x /nemo -s /nemo/singularity-nemo/

%labels
    Author c.wood@epcc.ed.ac.uk
    Version v0.0.1

%help
    This is a demo container used to illustrate a def file that uses all
    supported sections.